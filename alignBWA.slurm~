#!/bin/bash

#SBATCH --job-name=bwamem
#SBATCH --nodes=1
#SBATCH --ntasks-per-node=32
#SBATCH --mem=90000
#SBATCH --array=1-3
#SBATCH --output=/share/cdfwwildlife/MYLU_NovaSeq/SCRIPTS/slurmout/02_bwa_LowCov_%A_%a.out
#SBATCH --error=/share/cdfwwildlife/MYLU_NovaSeq/SCRIPTS/slurmout/02_bwa_LowCov_%A_%a.err

dir="/share/cdfwwildlife/MYLU_NovaSeq"

echo "Aligning to Mlc HiC genome with bwa mem..."
start=`date +%s`
echo $HOSTNAME
echo "My SLURM_ARRAY_TASK_ID: " $SLURM_ARRAY_TASK_ID

inpath="${dir}/01_HTS_PreProc/LowCov"
outpath="${dir}/02_AlignBWA/LowCov"

sample=`sed "${SLURM_ARRAY_TASK_ID}q;d" ${dir}/Sample_Lists/LowCov_samples.txt`
echo "SAMPLE: ${sample}"

echo "OUTPUT DIR: ${outpath}"
[[ -d ${outpath} ]] || mkdir -p ${outpath}
[[ -d ${outpath}/${sample} ]] || mkdir -p ${outpath}/${sample}


module load bwa
module load samtools

bwa mem -t 32 -R '@RG\tID:'${sample}'\tSM:'${sample} ${dir}/REF/mMyoLuc1.fa \
	${inpath}/${sample}/${sample}_preproc_R1.fastq.gz \
	${inpath}/${sample}/${sample}_preproc_R2.fastq.gz |
	samtools view -bh -@ 2 -m 3G - | \
	samtools sort -@ 2 -m 3G -O bam -o ${outpath}/${sample}/${sample}.subtest.sorted.bam

end=`date +%s`
runtime=$((end-start))
echo $runtime

## NOTES:
# !! only run 1-2 HiCov samples at a time !!
# samtools -@ -- allocate additional threads
# samtools -m -- only output alignments with given number of CIGAR bases consuming query sequence >= X




