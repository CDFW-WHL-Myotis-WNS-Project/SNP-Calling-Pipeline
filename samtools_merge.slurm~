#!/bin/bash

#SBATCH --nodes=1
#SBATCH --job-name=samtools_merge
#SBATCH --ntasks=8
#SBATCH --mem=4000
#SBATCH --array=1
#SBATCH --output=/share/cdfwwildlife/MYLU_NovaSeq/SCRIPTS/slurmout/03_merge_LowCov_%A_%a.out
#SBATCH --error=/share/cdfwwildlife/MYLU_NovaSeq/SCRIPTS/slurmout/03_merge_LowCov_%A_%a.err

dir="/share/cdfwwildlife/MYLU_NovaSeq"

echo "Merging sample sequences across lanes..."
start=`date +%s`
echo $HOSTNAME
echo "My SLURM_ARRAY_TASK_ID: " $SLURM_ARRAY_TASK_ID

sample=`sed "${SLURM_ARRAY_TASK_ID}q;d" ${dir}/Sample_Lists/LowCov_samples.merge.txt`
echo "SAMPLE: ${sample}"

inpath="${dir}/02_AlignBWA/LowCov"
outpath="${dir}/03_Merge"

echo "OUTPUT DIR: ${outpath}"
[[ -d ${outpath} ]] || mkdir -p ${outpath}
[[ -d ${outpath}/${sample} ]] || mkdir -p ${outpath}/${sample}

module load samtools

samtools merge -o ${outpath}/${sample}/${sample}.sorted.bam\
	${inpath}/${sample}_L001/${sample}*.sorted.bam\
	${inpath}/${sample}_L002/${sample}*.sorted.bam\
	${inpath}/${sample}_L003/${sample}*.sorted.bam

end=`date +%s`
runtime=$((end-start))
echo "RUNTIME: $runtime seconds"
echo "END ${sample}"
